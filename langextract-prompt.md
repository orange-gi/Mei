# LangExtract 提示词工程指南

## 一、提示词核心概念

### 1.1 提示词在LangExtract中的角色

在LangExtract框架中，提示词是连接用户意图与LLM能力的核心桥梁。与传统的监督学习方法不同，LangExtract不依赖大量标注数据进行模型训练，而是通过精心设计的自然语言提示词和少量示例来引导模型完成信息提取任务。这种方法被称为"基于提示的信息提取"或"零样本/少样本学习"，它充分利用了预训练语言模型中编码的世界知识和语言理解能力。

提示词在LangExtract的提取流程中扮演着多重角色。首先，它是任务定义者，明确告知模型需要提取什么信息、以什么格式输出。其次，它是约束制定者，通过格式要求和规则说明来规范模型的输出。第三，它是上下文提供者，通过示例和背景信息帮助模型理解特定领域的概念和期望的提取风格。一个设计良好的提示词可以显著提高提取的准确性、完整性和一致性。

### 1.2 提示词组成要素

一个完整的LangExtract提示词通常由以下几个核心要素组成：

**任务指令**是提示词的核心部分，它用自然语言描述需要完成的信息提取任务。任务指令应该清晰、具体，避免歧义。好的任务指令会明确指定要提取的实体类型、关系类型，以及提取的边界规则。例如，"提取文本中所有的人物名称、组织机构和地理位置"就是一个明确的任务指令。

**格式约束**定义了提取结果的输出格式和结构要求。格式约束可以包括：是否使用原文精确提取、是否允许 paraphrasing、提取结果的组织方式等。这些约束帮助模型生成格式一致、可以直接用于下游处理的结果。

**属性定义**说明了每个提取类别应该附带哪些属性信息。属性提供了关于实体的额外上下文，使提取结果更加丰富和有意义。例如，对于"药物"实体，可能需要定义" dosage "、" route "、" frequency "等属性。

**边界规则**明确了实体提取的边界处理方式，如是否允许重叠、如何处理嵌套实体、遇到歧义时如何处理等。这些规则对于处理复杂文本至关重要。

### 1.3 提示词与示例的关系

提示词和示例（Few-shot Examples）是互补的关系。提示词提供了任务的抽象描述，而示例则提供了具体任务的具象化展示。在LLM的上下文学习中，示例帮助模型理解提示词的含义和期望的输出风格，降低了模型理解的门槛。

在LangExtract中，示例通过`ExampleData`类定义，每个示例包含一段源文本和对应的提取结果。示例的质量和代表性直接影响模型对新文本的处理效果。优秀的示例集应该覆盖各种典型情况，包括：常见的实体类型、边界情况、歧义处理等。

## 二、提示词设计原则与最佳实践

### 2.1 清晰性原则

提示词的清晰性是成功提取的基础。模糊或含糊的提示词会导致模型的输出不一致或遗漏重要信息。以下是确保提示词清晰性的具体策略。

**使用明确的动词**：在任务指令中使用具体的动作动词，避免"提取相关信息"这类模糊表达，而应使用"识别并提取所有人物名称"、"列出所有提及的日期和事件"等明确表述。明确动词的使用帮助模型聚焦于具体的提取任务。

**定义提取边界**：清楚地说明提取的边界条件。例如，"只提取直接提到的实体，不进行推断"或"提取所有隐含的关系，即使未使用关系关键词"。边界定义可以显著减少过度提取或提取不足的问题。

**避免多义性**：确保提示词中的每个术语都有明确的含义。如果某个词可能有多种解释，应该在提示词中明确指定所需的含义。例如，"提取'公司'时，只包括法律实体，不包括部门或项目组"。

### 2.2 具体性原则

具体性原则要求提示词尽可能详细地描述提取需求，避免留有过多的解释空间。

**提供属性模板**：为每个提取类别定义明确的属性结构。例如，对于"事件"类别，可以定义为："提取事件类型（会议、事故、发布等）、参与方、时间和地点作为属性"。属性模板确保输出的结构一致性。

**说明处理规则**：对于复杂情况，预先定义处理规则。例如，"当同一个实体在文本中多次出现时，只提取第一次出现时的完整信息"，或"当多个实体共享相同的属性值时，在每个实体中重复记录该值"。

**举例说明边界情况**：在提示词中直接说明如何处理边界情况。例如，"即使实体名称只出现一部分，也应完整提取；例如，'纽约'不应只提取为'纽约'的缩写'NYC'"。

### 2.3 一致性原则

一致性原则确保模型在处理不同文本时产生格式和风格统一的输出。

**统一术语使用**：在提示词中使用一致的术语，避免同一概念使用多种表达。例如，如果决定使用"情感状态"作为属性名，就应在整个提示词中保持使用，不要在不同地方改用"情绪"或"感受"。

**固定输出格式**：明确指定输出的格式要求。例如，"所有提取结果必须使用JSON格式，每个提取包含extraction_class、extraction_text和attributes三个字段"。固定的输出格式便于后续的解析和处理。

**示例一致性**：确保提供的示例之间格式一致，示例与提示词描述一致。示例是模型学习的重要来源，不一致示例会导致模型输出风格的混乱。

### 2.4 迭代优化策略

提示词设计通常是一个迭代过程，需要根据实际提取效果不断调整和优化。

**初始版本设计**：首先基于对任务的理解设计初始提示词，使用少量测试文本验证基本功能。

**错误分析**：收集提取结果中的错误类型，包括：遗漏提取、错误提取、格式不一致、属性不完整等。针对每类错误，分析其可能的原因。

**针对性改进**：根据错误分析结果，有针对性地调整提示词。对于遗漏问题，可能需要加强任务描述或添加更多示例；对于错误提取，可能需要添加排除规则或更明确的边界定义。

**持续验证**：在每次调整后，使用测试集验证效果。建议维护一个固定的测试集，以便客观比较不同版本提示词的效果。

## 三、提示词模板与示例

### 3.1 基础提示词模板

以下是一个通用的提示词模板框架，可以根据具体任务进行定制：

```python
import textwrap

base_prompt = textwrap.dedent("""\
    ## 任务描述
    从以下文本中提取{任务目标}。
    
    ## 提取规则
    1. 使用精确原文进行提取，不要改写或意译
    2. 实体之间不允许重叠
    3. 按实体在文本中出现的顺序进行提取
    4. 每个实体必须附带以下属性：{属性列表}
    
    ## 边界情况处理
    {边界规则说明}
    
    ## 输出格式
    请严格按照JSON格式输出，结构如下：
    {输出格式说明}
    """)
```

### 3.2 文学文本分析示例

以下是一个从文学文本中提取角色、情感和关系的提示词示例：

```python
literature_prompt = textwrap.dedent("""\
    Extract characters, emotions, and relationships in order of appearance.
    Use exact text for extractions. Do not paraphrase or overlap entities.
    Provide meaningful attributes for each entity to add context.
    
    For characters:
    - extraction_class: "character"
    - attributes: {"role": "protagonist/antagonist/supporting", "emotional_state": "current emotional state if mentioned"}
    
    For emotions:
    - extraction_class: "emotion"
    - attributes: {"feeling": "specific emotion", "trigger": "what caused this emotion"}
    
    For relationships:
    - extraction_class: "relationship"
    - attributes: {"type": "family/romantic/professional/conflict", "description": "brief description"}
    
    Output each extraction as a JSON object with extraction_class, extraction_text, and attributes.
    """)
```

### 3.3 医疗文档提取示例

以下是一个从临床笔记中提取医疗信息的提示词示例：

```python
medical_prompt = textwrap.dedent("""\
    从以下临床记录中提取结构化的医疗信息。
    
    ## 提取类别
    
    1. 诊断 (diagnosis)
       - 提取所有明确的诊断结果
       - 属性：诊断类型（主要/次要）、状态（活动期/缓解期/历史）
    
    2. 药物 (medication)
       - 提取所有提及的药物名称
       - 属性：剂量、给药途径、频率、起止时间
    
    3. 症状 (symptom)
       - 提取患者报告或记录的症状
       - 属性：严重程度（轻/中/重）、持续时间、部位
    
    4. 检查 (procedure)
       - 提取所有医学检查和程序
       - 属性：检查日期、结果（如有提及）
    
    ## 提取规则
    - 只提取明确提及的信息，不进行医学推断
    - 使用原文精确提取，不要改写
    - 同一个药物多次提及时，只记录首次出现的信息
    """)
```

### 3.4 法律文档提取示例

以下是一个从法律文书中提取关键信息的提示词示例：

```python
legal_prompt = textwrap.dedent("""\
    从以下法律文档中提取案件相关信息。
    
    ## 当事人 (party)
    - 提取所有当事人信息
    - 属性：类型（原告/被告/第三人）、名称、代理人（如有）
    
    ## 案件事实 (fact)
    - 提取关键案件事实
    - 属性：时间、地点、涉及人员、事实类型
    
    ## 法律依据 (legal_basis)
    - 提取引用的法律条文和先例
    - 属性：法条编号、先例名称、适用条款
    
    ## 争议焦点 (issue)
    - 提取案件的主要争议点
    - 属性：争议类型、涉及的法律问题
    
    ## 裁决/诉求 (ruling_claim)
    - 提取法院裁决或当事人诉求
    - 属性：类型（裁决/诉求/抗辩）、内容、结果
    
    ## 重要日期 (date)
    - 提取所有重要日期
    - 属性：日期类型（起诉日/开庭日/判决日等）、关联事件
    """)
```

### 3.5 商业文档提取示例

以下是从商业报告中提取关键业务信息的提示词示例：

```python
business_prompt = textwrap.dedent("""\
    从以下商业文档中提取关键业务信息。
    
    ## 实体提取
    
    1. 公司/组织 (company)
       - 提取所有提及的公司和组织
       - 属性：类型（客户/竞争对手/合作伙伴/子公司）、关联业务
    
    2. 产品/服务 (product)
       - 提取所有提及的产品和服务
       - 属性：类型、版本/型号、发布状态
    
    3. 财务指标 (financial_metric)
       - 提取所有财务数据和指标
       - 属性：指标类型（收入/利润/成本/增长率）、时间范围、币种
    
    4. 关键事件 (event)
       - 提取重要的业务事件
       - 属性：事件类型（发布/并购/合作/诉讼）、日期、参与方
    
    ## 关系提取
    
    5. 合作关系 (partnership)
       - 提取公司之间的合作关系
       - 属性：合作类型、开始时间、状态（进行中/已终止）
    
    ## 提取规则
    - 金额数值需完整提取，包括货币单位和精度
    - 百分比需包含百分号
    - 日期格式保持原文形式
    - 不提取泛泛的描述性语句，只提取具体信息
    """)
```

## 四、Few-shot示例设计

### 4.1 示例数据结构

在LangExtract中，示例通过`ExampleData`类定义，包含源文本和对应的提取结果：

```python
import langextract as lx

example = lx.data.ExampleData(
    text="ROMEO. But soft! What light through yonder window breaks? It is the east, and Juliet is the sun.",
    extractions=[
        lx.data.Extraction(
            extraction_class="character",
            extraction_text="ROMEO",
            attributes={"emotional_state": "wonder"}
        ),
        lx.data.Extraction(
            extraction_class="emotion",
            extraction_text="But soft!",
            attributes={"feeling": "gentle awe"}
        ),
        lx.data.Extraction(
            extraction_class="relationship",
            extraction_text="Juliet is the sun",
            attributes={"type": "metaphor"}
        ),
    ]
)
```

### 4.2 优质示例的特征

一个优质的示例应该具备以下特征：

**准确性**：示例中的提取结果必须是正确的。如果示例本身包含错误，模型会学习这些错误模式。验证示例准确性通常需要人工复核或参考可靠数据源。

**代表性**：示例应该代表目标任务的典型情况。不同类型的实体、不同格式的文本、不同复杂度的结构都应该有对应的示例覆盖。

**边界覆盖**：除了典型情况，示例还应该包含一些边界情况，如重叠实体、歧义名称、嵌套关系等。这些边界情况的处理方式通过示例传达给模型。

**一致性**：同一示例集内的所有示例应该遵循相同的提取规则和格式。如果某些实体在某个示例中提取，在另一个相似示例中却不提取，会造成模型困惑。

### 4.3 示例数量与质量权衡

关于示例数量，存在一个收益递减的规律。通常3-5个高质量示例可以显著提高提取效果，但超过一定数量后，增加示例带来的改善变得有限。

**质量优先**：相比数量，示例的质量更为重要。2-3个高质量、覆盖各种情况的示例，通常优于10个质量参差不齐的示例。

**动态调整**：在实际应用中，可以根据提取效果动态调整示例集。如果某些类型的实体经常被遗漏，可以添加针对性的示例；如果某些提取错误反复出现，可以添加展示正确处理的示例。

**定期更新**：随着应用场景的变化（如新类型的实体出现），需要更新示例集以适应新的需求。保持示例集的时效性对于维持提取质量很重要。

### 4.4 领域特定示例设计

不同领域的示例设计有不同的考量：

**医疗领域**：示例应覆盖各种病历格式，包括结构化表格和非结构化叙述。需要注意医学术语的精确性，以及症状、诊断、药物之间的关系表达。隐私保护也是重要考虑，示例应使用脱敏数据或公开数据集。

**法律领域**：示例应涵盖不同类型的法律文书（判决书、合同、诉状等），体现法律文本的专业术语和规范表达。需要注意法律引用的格式，以及当事人关系的准确识别。

**金融领域**：示例应覆盖各种财务文档类型，包括年报、新闻稿、分析师报告等。需要确保数字和金额的精确提取，以及公司名称和业务描述的准确识别。

**学术领域**：示例应涵盖论文、专利、技术报告等文献类型。需要准确提取作者、机构、研究方法、实验结果等学术相关信息。

## 五、提示词高级技巧

### 5.1 链式思考提示

对于复杂的提取任务，可以采用链式思考（Chain-of-Thought）技术，引导模型逐步推理：

```python
chain_prompt = textwrap.dedent("""\
    从以下文本中提取所有的人物关系。请按以下步骤思考：
    
    步骤1：识别文本中所有的人物名称
    步骤2：分析每对人物之间是否存在关系
    步骤3：确定每种关系的类型（家庭、同事、朋友、敌人等）
    步骤4：提取关系描述的原文片段
    步骤5：验证提取的关系是否有足够的文本支持
    
    请输出每一步的发现，并在最后汇总所有提取的关系。
    """)
```

### 5.2 自我一致性提示

对于需要高准确性的场景，可以采用自我一致性（Self-Consistency）策略，多次生成并选择最一致的答案：

```python
consistency_prompt = textwrap.dedent("""\
    请从以下文本中提取所有重要的事实陈述。
    对于每个事实，请：
    1. 提取事实的原文表述
    2. 标注事实的主题类别
    3. 标注事实的置信度（高/中/低）
    
    在提取过程中，请考虑事实之间是否存在冲突，并优先保留置信度高的事实。
    """)
```

### 5.3 对抗性提示设计

为了提高模型对错误提取的鲁棒性，可以在提示词中明确说明需要避免的错误：

```python
robust_prompt = textwrap.dedent("""\
    从以下文本中提取实体和关系。请特别注意避免以下常见错误：
    
    1. 过度提取：不要将修饰语或属性错误地提取为独立实体
       - 例如："张三的公司"应提取为"张三"（人物），而非"张三的公司"
    
    2. 指代错误：不要将代词直接提取为实体
       - 例如："他去了北京"应提取"北京"，而非"他"
    
    3. 范围过大：不要提取包含多个独立实体的复合短语
       - 例如："北京、上海、广州"应提取为三个独立的城市实体
    
    4. 重复提取：不要对同一实体在不同上下文中重复提取
    
    请仔细阅读文本，确保提取的准确性和完整性。
    """)
```

### 5.4 条件分支提示

对于需要根据上下文判断是否提取的情况，可以使用条件分支提示：

```python
conditional_prompt = textwrap.dedent("""\
    从以下文本中提取组织机构信息，但请注意以下规则：
    
    1. 如果组织名称在文本中首次出现，提取完整名称
       - 例如："Google LLC"首次出现时应完整提取
    
    2. 如果同一组织在后续文本中使用简称，只提取该简称
       - 例如：在"Google LLC"之后提到"Google"，只提取"Google"
    
    3. 如果组织名称包含在引号或特殊标记中，可能是不当引用，需谨慎提取
    
    4. 提取每个组织时，请标注：
       - 组织类型（公司/政府/非营利/教育等）
       - 在本文本中扮演的角色
    """)
```

## 六、提示词版本管理与优化

### 6.1 提示词版本控制

建议对提示词进行版本控制，记录每次修改的内容和原因：

```python
# 提示词版本示例
PROMPT_VERSIONS = {
    "v1.0": {
        "prompt": "原始提示词文本",
        "date": "2025-01-01",
        "changes": "初始版本",
        "metrics": {"precision": 0.85, "recall": 0.78, "f1": 0.81}
    },
    "v1.1": {
        "prompt": "修改后的提示词文本",
        "date": "2025-01-15",
        "changes": "添加了边界情况处理说明",
        "metrics": {"precision": 0.87, "recall": 0.82, "f1": 0.84}
    }
}
```

### 6.2 A/B测试策略

对于重要的提示词改进，可以采用A/B测试来验证效果：

```python
# A/B测试配置示例
ab_test_config = {
    "control": {
        "prompt_version": "v1.0",
        "weight": 0.5
    },
    "treatment": {
        "prompt_version": "v1.1", 
        "weight": 0.5
    },
    "evaluation_metrics": ["precision", "recall", "f1", "extraction_time"]
}
```

### 6.3 效果评估指标

建议使用以下指标评估提示词效果：

**准确率（Precision）**：提取的结果中正确的比例。高准确率意味着误提取少。

**召回率（Recall）**：应该提取的结果中被正确提取的比例。高召回率意味着遗漏少。

**F1分数**：准确率和召回率的调和平均，提供综合评估。

**一致性**：同一提示词处理相似文本时输出的一致程度。

**处理时间**：提示词执行的时间，影响系统的响应速度。

### 6.4 持续优化循环

建立持续优化的工作流程：

1. **收集反馈**：从用户和下游系统收集提取结果的反馈
2. **错误分类**：将错误分为不同类型（遗漏、误提取、格式错误等）
3. **根因分析**：分析每类错误与提示词设计的关系
4. **针对性改进**：调整提示词以解决特定问题
5. **验证测试**：使用测试集验证改进效果
6. **部署更新**：将优化的提示词部署到生产环境

## 七、提示词调试与故障排查

### 7.1 常见问题与解决方案

**问题一：提取结果不完整**
- 可能原因：任务描述不够明确，示例不足
- 解决方案：在提示词中添加更详细的任务说明，添加展示完整提取的示例

**问题二：提取结果包含错误内容**
- 可能原因：边界规则不清晰，示例中包含错误示范
- 解决方案：添加明确的排除规则，检查并修正示例

**问题三：输出格式不一致**
- 可能原因：格式要求不明确，提示词内部描述冲突
- 解决方案：明确定义输出格式，提供格式示例

**问题四：模型拒绝提取**
- 可能原因：提示词触发安全过滤，任务定义不清晰
- 解决方案：调整提示词措辞，确保任务描述正面、清晰

### 7.2 调试工具与技巧

**输出LLM原始响应**：在开发阶段，捕获并分析LLM的原始输出，诊断提示词理解问题。

**使用简单测试文本**：先用简短、明确的测试文本验证提示词功能，再逐步过渡到复杂文本。

**单步调试**：禁用多轮提取和并行处理，使用单线程单轮模式，便于追踪问题。

**日志记录**：记录每次提取的提示词、输入文本和输出结果，便于问题追溯。

### 7.3 提示词敏感性分析

分析提示词各部分对结果的影响程度：

```python
# 敏感性测试示例
sensitivity_tests = {
    "remove_task_description": lambda p: p.replace("## 任务描述\n...", ""),
    "remove_extraction_rules": lambda p: p.replace("## 提取规则\n...", ""),
    "remove_examples": lambda p: p.replace("## 示例\n...", ""),
    "simplify_prompt": lambda p: "从文本中提取关键信息。"  # 极简版本
}

# 比较不同版本的效果差异
def compare_sensitivity(original_prompt, tests):
    results = {}
    for test_name, transform in tests.items():
        test_prompt = transform(original_prompt)
        result = evaluate_extraction(test_prompt)
        results[test_name] = result
    return results
```

## 八、提示词工程资源与参考

### 8.1 官方资源

LangExtract项目提供了丰富的文档和示例，涵盖各种应用场景。建议开发者首先阅读项目README和docs目录下的示例文档，了解官方推荐的提示词设计模式。

### 8.2 社区实践

LangExtract社区贡献了多种自定义Provider实现和相关工具。在设计提示词时，可以参考社区分享的经验，特别是针对特定领域（如医疗、法律、金融）的实践案例。

### 8.3 相关技术

提示词工程与大语言模型研究密切相关。建议关注以下相关领域的发展：

- Chain-of-Thought Reasoning（链式思考推理）
- Self-Consistency（自我一致性）
- Prompt Injection（提示词注入防护）
- Few-shot Learning（少样本学习）
- In-Context Learning（上下文学习）

这些领域的最新研究成果可以转化为LangExtract提示词设计的改进策略。

## 九、总结

提示词工程是LangExtract有效使用的核心技能。通过遵循清晰性、具体性、一致性原则，结合迭代优化策略，开发者可以设计出高质量的提示词，显著提升信息提取的准确性和效率。Few-shot示例作为提示词的重要补充，需要精心设计以覆盖各种典型情况和边界情况。

随着大语言模型能力的不断增强，提示词工程的重要性将进一步凸显。掌握提示词设计的方法论，不仅对LangExtract使用有益，也为未来与AI系统的更广泛交互奠定基础。建议开发者建立提示词版本管理和持续优化的机制，不断积累和分享最佳实践，推动整个社区的提示词工程能力提升。
