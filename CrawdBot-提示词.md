# Clawdbot 提示词分析

## 提示词系统概述

Clawdbot 作为一款个人 AI 助手项目，其提示词系统采用了分层设计，将核心身份定义、工具能力描述、行为规则和会话管理等多个维度的提示词组织成清晰的结构。这种设计不仅便于维护和更新，还支持用户在运行时动态调整 AI 助手的行为模式。理解 Clawdbot 的提示词系统对于深度定制助手行为、排查对话问题以及开发新技能都具有重要的指导意义。

从架构角度来看，Clawdbot 的提示词系统可以分为四个主要层次：系统级提示词、工作区级提示词、技能级提示词和会话级提示词。系统级提示词定义了 AI 助手的核心身份和能力边界，这部分内容在程序启动时加载，对所有会话生效。工作区级提示词位于用户主目录下的 `~/clawd/` 目录中，包含了用户自定义的智能体配置、身份设定和工具定义。技能级提示词存放在每个技能的专属目录中，定义了技能的功能描述和调用方式。会话级提示词则是动态生成的，根据当前会话的上下文、历史消息和用户指令实时构建。

Clawdbot 的提示词设计遵循了几个核心原则。首先是可配置性原则，用户可以通过编辑配置文件和提示词文件来定制 AI 助手的行为，无需修改核心代码。其次是安全性原则，系统提供了沙箱隔离、工具权限控制和提示词注入防护等机制，确保用户数据和系统安全。第三是扩展性原则，技能系统允许开发者在不修改核心代码的情况下添加新的功能，技能级的提示词设计使得技能能够被系统自动发现和正确调用。

---

## 提示词位置与文件结构

### 系统级提示词文件

Clawdbot 的系统级提示词主要分布在源代码目录中，这些文件定义了 AI 助手的基础能力和行为模式。虽然这些文件通常不需要用户直接修改，但了解它们的位置和内容对于理解系统的工作原理很有帮助。核心的提示词定义分布在 `src/` 目录下的各个模块中，与具体的实现逻辑紧密耦合。这种设计使得系统级的提示词能够与功能代码同步更新，确保 AI 助手的行为与系统能力保持一致。

项目根目录下的 `AGENTS.md` 文件是一个重要的配置说明文件，它记录了智能体的配置方式和使用指南。这个文件虽然不是直接的提示词内容，但为用户理解和配置 AI 助手提供了详细的参考。`CLAUDE.md` 文件则专门为使用 Claude AI 进行代码开发的场景提供了项目说明，帮助 AI 助手理解项目结构和开发规范。这些文档文件在某种意义上也起到了系统提示词的作用，它们定义了项目的约束、约定和最佳实践。

### 工作区级提示词文件

工作区级提示词是用户可以自定义的核心文件，它们存放在 `~/clawd/` 目录下（路径可通过配置修改）。这个目录是 Clawdbot 的用户数据目录，在首次运行引导程序时会自动创建。用户在引导过程中选择的所有配置、启用的渠道和安装的技能都会在这个目录下留下相应的配置和数据。

`AGENTS.md` 文件位于工作区根目录，定义了智能体的配置参数和行为规则。这个文件通常包含默认智能体的设置、特定渠道的智能体配置以及多智能体路由规则。智能体配置采用了声明式的格式，用户可以指定模型选择、工具白名单、沙箱模式等关键参数。这种设计允许用户为不同的使用场景创建不同的智能体配置，例如为工作场景创建一个严谨专业的智能体，为个人使用创建一个轻松友好的智能体。

`SOUL.md` 文件定义了 AI 助手的核心身份和人格设定。这是最能体现用户个性化的文件，用户可以在这里描述助手的名字、性格特点、说话风格、专业领域等身份特征。好的身份定义能够让 AI 助手的回答更加一致和有特色，增强用户的使用体验。身份设定的提示词通常包括三个部分：基础身份描述（名字、角色）、行为风格指导（语气、用词习惯）和专业领域说明（擅长的领域、知识的边界）。

`TOOLS.md` 文件定义了当前工作区可用的工具列表和每个工具的功能描述。这个文件在技能安装或工具配置发生变化时会自动更新，但用户也可以手动编辑以微调工具描述或添加自定义的工具说明。工具描述的质量直接影响 AI 助手调用工具的效果，清晰准确的描述能够帮助 AI 正确理解工具的用途和参数格式，从而提高工具调用的成功率。

### 技能级提示词文件

每个技能都包含一个 `SKILL.md` 文件，位于技能的专属目录 `~/clawd/skills/<技能名>/` 下。这个文件是技能系统的核心，它定义了技能的元数据、功能描述、参数规范和调用方式。技能目录结构支持多种类型的技能：捆绑技能（随 Clawdbot 核心一起分发）、托管技能（由云端服务提供）和工作区技能（用户或社区开发的本地技能）。

技能提示词文件的结构通常包含以下几个部分：技能名称和版本信息、一句话功能描述、详细的功能说明、使用示例、参数定义和返回值格式。技能系统会解析这些文件，提取结构化的信息用于技能的注册、发现和调用。这种设计使得技能的添加和移除变得非常简单，用户只需将技能目录放到指定位置或从中移除，系统在下次启动时就会自动处理相应的变化。

技能还支持安装门控（installation gating）和用户界面集成。每个技能可以定义自己的安装前提条件（如需要特定的配置项或依赖服务），以及在用户界面上展示的元数据（如图标、分类、详细说明）。这些信息帮助用户在众多可用技能中找到符合自己需求的选项，同时也为技能市场的实现提供了基础。

---

## 核心提示词内容分析

### 模型配置与选择策略

Clawdbot 的提示词系统与 AI 模型紧密集成，模型的选择直接影响提示词的处理效果和最终的回答质量。项目文档中特别推荐使用 Anthropic Pro/Max 订阅配合 Opus 4.5 模型，这一推荐背后有其深层次的技术考量。Opus 4.5 模型在长上下文处理方面表现出色，这对于需要处理大量对话历史或长文档的使用场景非常重要。更重要的是，该模型在提示词注入（prompt injection）攻击的防护方面具有较强的能力，这对于运行在用户设备上的本地 AI 助手来说是一个重要的安全考量。

模型配置在提示词层面的体现主要有两个方面：一是系统提示词中包含的模型能力描述，二是用户配置的工具列表与模型可用能力之间的匹配。系统会根据用户选择的模型类型调整提示词的一些细节，例如对于支持思考模式（thinking modes）的模型，提示词可能会包含如何有效利用这一能力的指导。模型故障转移机制也是通过提示词层面实现的，当主模型不可用时，系统会自动将请求切换到备用模型，并在提示词中注明当前的模型状态。

认证配置是模型使用的基础，Clawdbot 支持两种认证方式：OAuth 授权和 API 密钥。OAuth 方式主要用于 Anthropic 和 OpenAI 的官方订阅，它能够自动处理令牌的刷新和过期问题，用户体验更加流畅。API 密钥方式更加灵活，适用于自定义的模型服务或第三方提供商，但需要用户自行管理密钥的安全和更新。认证信息存储在配置文件中，在构建提示词调用时会从配置中读取相应的认证信息并添加到请求头中。

### 思考级别控制机制

Clawdbot 提供了一套精细的思考级别（thinking levels）控制机制，用户可以通过 `/think` 命令或 CLI 参数来调整 AI 的思考深度。这一机制主要适用于支持思考模式的模型（如 GPT-4.2 及以上版本、Claude 某些版本），通过控制模型的推理过程来平衡回答质量和响应速度。

思考级别分为六个档次：`off`（关闭思考模式，直接生成回答）、`minimal`（仅进行最基本的推理）、`low`（有限的推理步骤）、`medium`（标准的推理深度）、`high`（深入的推理分析）和 `xhigh`（最大程度的推理探索）。不同级别之间的差异主要体现在输入提示词中关于推理过程的指导，以及输出结果中推理内容的可见程度。较高的思考级别会让模型在生成最终回答前进行更多的中间推理步骤，这些推理内容可以选择性地展示给用户（通过 `--thinking high` 参数），帮助用户理解 AI 的思考过程。

思考级别的选择在不同的使用场景下有不同的最佳实践。对于简单的事实性问题，低级别的思考就足够了，启用高级别思考反而会增加响应延迟和令牌消耗。对于复杂的分析性问题或需要多步推理的任务，启用高级别思考能够显著提高回答质量。用户可以通过实验来找到适合自己需求的思考级别配置，也可以针对不同类型的会话设置不同的默认级别。

### 详细程度与使用统计

Clawdbot 提供了详细程度（verbosity）控制功能，用户可以通过 `/verbose on|off` 命令来切换回答的详细程度。启用详细模式时，AI 助手会提供更详细的解释、更多的背景信息和更完整的问题覆盖。关闭详细模式时，回答会更加简洁直接，适合已经熟悉话题或时间紧迫的场景。这个功能在提示词层面的实现方式是调整输出格式模板，详细模式会在回答后添加额外的解释段落、参考信息和替代方案建议。

使用统计功能提供了每次响应消耗的资源信息，包括令牌数量和估算的成本。用户可以通过 `/usage off|tokens|full` 命令来控制统计信息的展示级别：`off` 完全不显示统计信息，`tokens` 仅显示令牌使用量，`full` 则显示完整的统计报告包括成本估算。这一功能对于管理 API 配额和控制使用成本非常有用，特别是在使用按量付费的模型服务时。统计信息在提示词层面的实现是在每次模型调用后由系统自动计算并添加到响应元数据中。

---

## 设计模式与技巧

### 会话类型与隔离策略

Clawdbot 采用了会话类型区分的设计来管理不同场景下的 AI 行为。主会话（main session）是最完整的会话类型，AI 助手拥有完全的权限，可以访问所有已配置的工具和资源。这种会话类型适用于用户与 AI 助手的直接交互，是功能最完整的交互模式。系统提示词中会明确标注当前是主会话，以便 AI 助手采取相应的行为策略。

非主会话（non-main session）是为群组和频道场景设计的受限会话类型。在这种会话中，AI 助手运行在隔离的环境中，可能无法访问所有工具或只能访问受限的工具集合。这种隔离策略是出于安全和隐私的考虑，防止在群组场景下 AI 的行为影响到不相关的用户或系统资源。非主会话可以通过配置选择是否在 Docker 沙箱中运行，进一步增强安全性。

激活模式（activation mode）控制了 AI 助手在群组对话中如何响应消息。`mention` 模式要求用户在消息中明确提及 AI 助手（如 @clawdbot），AI 才会响应；`always` 模式则会让 AI 助手监听所有消息并主动响应。这种区分在提示词层面的体现是系统提示词中包含的激活条件判断逻辑，AI 助手会根据消息内容判断自己是否应该响应。队列模式则用于处理高并发场景，将多条消息排队处理，确保响应顺序和资源合理分配。

### 多智能体路由机制

Clawdbot 的多智能体路由机制是系统的高级功能，它允许将不同的入站渠道、账户或对等端路由到相互隔离的智能体实例。这种设计在以下几个场景中特别有用：为不同的家庭成员提供独立的 AI 助手体验、为不同的项目或客户配置专属的智能体、在群组中为不同的讨论主题创建专门化的 AI 助手。

每个智能体实例拥有独立的工作区和会话上下文，这意味着在一个智能体中进行的操作不会影响到其他智能体的状态。系统提供了跨会话协作工具，允许智能体之间进行受控的信息交换：`sessions_list` 用于发现活跃的会话及其元数据，`sessions_history` 用于获取会话的转录日志，`sessions_send` 用于向其他会话发送消息，`sessions_spawn` 用于创建新的会话实例。这些工具的存在和权限由系统提示词定义，AI 助手在执行跨会话操作时会检查相应的权限。

安全工具列表的设计体现了最小权限原则。默认情况下，主会话可以访问的敏感工具（如 bash 命令执行、文件读写）可能对非主会话不可用。系统提示词中会明确列出当前会话可以使用的工具列表，AI 助手在规划行动时会严格遵守这一限制。对于需要更高权限的操作，用户可以通过 `/elevated on|off` 命令为当前会话开启提升权限，但这一操作需要谨慎使用，因为它可能带来安全风险。

### 提示词注入防护

提示词注入是 AI 助手系统面临的主要安全威胁之一，攻击者通过在输入中嵌入恶意指令来试图覆盖或绕过系统的原始提示词。Clawdbot 采用了多层防护策略来应对这一威胁。在模型层面，项目推荐使用 Anthropic 模型，因为该系列模型在提示词注入防护方面有较好的表现，能够更可靠地识别和忽略恶意输入。

在架构层面，Clawdbot 提供了沙箱隔离机制，将不同安全级别的会话运行在独立的执行环境中。通过配置 `agents.defaults.sandbox.mode: "non-main"`，可以让非主会话在 Docker 沙箱中运行，这样即使发生提示词注入攻击，攻击者能够影响的范围也被限制在沙箱内部，无法触及主机系统的敏感资源。沙箱配置在系统提示词中明确声明，AI 助手会据此调整自己的行为边界。

在提示词设计层面，系统提示词采用了指令分离（instruction separation）的技术来提高抗注入能力。关键的系统和用户指令被明确区分，并使用特殊的格式标记。提示词中还会包含关于如何处理可疑输入的指导，例如当检测到可能的注入尝试时应该如何响应。这些设计使得即使攻击者能够在部分输入中注入恶意内容，也难以完全覆盖系统的原始指令。

---

## 变量与模板处理

### 动态提示词构建

Clawdbot 的提示词系统在运行时动态构建完整的提示词内容，将多个来源的信息组合成最终发送给 AI 模型的消息。这一过程涉及多个变量的替换和模板的填充，确保每次请求的提示词都包含最新的上下文信息。动态构建的核心逻辑位于系统的核心模块中，对用户透明，但理解这一过程有助于调试问题和优化性能。

系统变量是在每次提示词构建时自动填充的信息，包括当前时间戳、当前会话 ID、用户身份信息、对话历史摘要等。这些变量使得提示词能够根据当前情境进行调整，而不是使用静态的固定内容。例如，当前时间戳变量让 AI 助手能够提供时效性相关的回答，用户身份变量帮助 AI 助手个性化其响应风格。

上下文变量根据当前会话的状态动态生成，包括最近的对话历史、已识别的用户意图、可用工具的状态等。对话历史变量尤为重要，它决定了 AI 助手能够记住多少之前的交流内容。由于模型有上下文长度限制，系统需要智能地选择和摘要历史消息，这一过程受到提示词中关于上下文管理策略的指导影响。

### 工具调用模板

工具调用是 Clawdbot 提示词系统的核心能力之一，系统需要准确地将工具描述转换为模型能够理解和执行的格式。工具调用的提示词模板包含三个主要部分：工具列表描述、调用格式说明和结果处理指南。工具列表描述向模型介绍当前会话可以使用的所有工具及其功能，是模型决定是否需要调用工具以及调用哪个工具的依据。

调用格式说明定义了当模型决定调用工具时应该输出的格式。这个格式通常包含工具名称、参数名称和参数值等字段，模型需要按照这个格式输出以触发工具调用。格式的设计需要平衡完整性和简洁性，既要包含所有必要的信息，又要尽量减少模型出错的可能性。好的格式设计会使用清晰的标记和示例，让模型能够准确地理解和遵守。

结果处理指南告诉模型在收到工具调用结果后应该如何处理。这个指南通常包括如何解读结果、如何将结果整合到回答中、以及在结果不符合预期时应该如何处理。复杂的多步工具调用场景需要更详细的结果处理指导，确保模型能够正确地理解和利用工具返回的信息。

### 会话状态模板

会话状态模板用于在每次交互开始时向 AI 模型介绍当前会话的基本情况。这个模板包含了会话的类型标识、用户的激活模式、系统的配置参数等关键信息。好的会话状态模板能够让 AI 助手快速了解当前的情境，采取适当的响应策略。

会话类型标识在模板中明确标注当前是主会话还是非主会话，这决定了 AI 助手可以采取的行动范围。如果是群组会话，还会包含群组的标识和成员信息，帮助 AI 助手理解当前的交流场景。激活模式信息告诉 AI 助手应该如何响应消息，是需要被明确提及还是应该主动参与讨论。

配置参数的模板化使得用户可以在运行时动态调整 AI 助手的行为，而无需修改系统代码。例如，用户可以通过配置界面调整详细程度、思考级别等参数，这些调整会反映在下次提示词构建时的配置变量中。这种动态配置能力是 Clawdbot 可定制性的重要组成部分。

---

## 提示词优化建议

### 身份定义优化

`SOUL.md` 文件中的身份定义是影响 AI 助手回答风格的核心因素，一个好的身份定义能够让 AI 助手的回答更加一致、个性化和有针对性。以下是一些优化身份定义的最佳实践建议。首先，身份描述应该具体而非抽象，避免使用空泛的形容词，而是提供具体的例子和场景说明。例如，不要只说「友好的助手」，而应该说「在回答问题时使用轻松的语气，常用鼓励性的表达，如『这是一个很棒的问题！』或『让我来帮你找出答案』」。

其次，身份定义应该包含明确的专业领域边界。如果 AI 助手在某个领域有特别的知识或擅长的问题类型，应该在身份定义中明确说明，这有助于 AI 在遇到超出范围的问题时给出恰当的回应（如建议用户寻求专业人士的帮助）。同时，专业领域的定义也会影响 AI 回答问题的深度和详细程度，对于专业领域的问题可以给出更深入的分析。

第三，身份定义应该考虑目标用户的特点。根据主要用户群体的背景（技术背景、行业领域、使用场景等），调整 AI 助手的表达方式和术语使用。对于技术用户，可以使用更多的专业术语和缩写；对于普通用户，则应该使用更通俗易懂的语言。这种用户适应性的设计能够让交互更加自然和高效。

### 工具描述优化

`TOOLS.md` 文件中的工具描述质量直接影响 AI 助手调用工具的效果。以下是优化工具描述的一些建议。工具描述应该清晰、简洁、准确地说明工具的功能和用途。避免使用模糊或容易引起误解的表述，每句话都应该有明确的信息价值。好的工具描述通常包含三个要素：工具能做什么（功能描述）、什么时候应该使用（使用场景）和使用后会发生什么（结果说明）。

参数描述是工具描述中特别重要的部分，每个参数的名称、类型、必需性和取值范围都应该准确说明。对于复杂的参数结构，应该提供具体的示例来帮助理解。好的参数描述能够显著减少 AI 助手调用工具时的错误率，提高工具调用的成功率。同时，参数描述中也应该包含对常见错误值或边界情况的提醒，帮助 AI 助手进行输入验证。

工具之间的依赖关系和调用顺序也应该在工具描述中有所体现。如果某个工具的输出是另一个工具的输入，或者某些工具必须按特定顺序调用，这些信息应该在相关工具的描述中明确说明。这种元信息的提供能够帮助 AI 助手在规划复杂任务时做出正确的决策，避免因顺序错误或遗漏依赖而导致的执行失败。

### 提示词结构优化

提示词的整体结构对于 AI 助手理解和执行指令也有重要影响。以下是一些结构优化的建议。提示词应该遵循清晰的层级结构，将不同类型的信息组织到独立的区块中。例如，系统指令、上下文信息、工具描述和用户输入应该有明显的分隔，AI 助手能够快速定位和理解各个部分的内容。

提示词的长度需要根据具体场景进行平衡。过短的提示词可能无法提供足够的上下文信息，导致 AI 助手的回答不够准确或相关；过长的提示词则可能稀释关键信息，增加模型处理的开销，并且可能导致重要的指令被忽略在大量文字中。合理的做法是将最重要的指令放在提示词的前面（因为模型对开头和结尾的内容记忆更深刻），次要的信息放在中间位置。

提示词的更新和版本管理也是需要考虑的因素。当系统升级、添加新功能或调整策略时，相关的提示词也需要相应更新。建立清晰的提示词版本管理机制，记录每次变更的内容和原因，有助于追踪问题和保持系统的一致性。同时，保留历史版本也便于在更新后出现问题时快速回滚。
